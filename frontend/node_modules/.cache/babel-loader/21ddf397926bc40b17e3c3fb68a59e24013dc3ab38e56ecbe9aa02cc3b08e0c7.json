{"ast":null,"code":"// src/lib/cart.js\nconst KEY = 'cart';\nconst EVENT_NAME = 'cart:changed';\n\n/** ปลอดภัยเวลา localStorage ใช้ไม่ได้ (เช่น SSR / โหมด privacy) */\nfunction safeLocal() {\n  try {\n    if (typeof window !== 'undefined' && window.localStorage) return window.localStorage;\n  } catch {}\n  // fallback in-memory (จะหายเมื่อรีเฟรช)\n  const mem = {\n    v: '{}'\n  };\n  return {\n    getItem: k => {\n      var _JSON$parse$k;\n      return (_JSON$parse$k = JSON.parse(mem.v || '{}')[k]) !== null && _JSON$parse$k !== void 0 ? _JSON$parse$k : null;\n    },\n    setItem: (k, v) => {\n      const o = JSON.parse(mem.v || '{}');\n      o[k] = v;\n      mem.v = JSON.stringify(o);\n    },\n    removeItem: k => {\n      const o = JSON.parse(mem.v || '{}');\n      delete o[k];\n      mem.v = JSON.stringify(o);\n    }\n  };\n}\nfunction dispatchChanged() {\n  if (typeof window !== 'undefined') {\n    window.dispatchEvent(new Event(EVENT_NAME));\n  }\n}\nfunction normalizeNumber(n, def = 0) {\n  const v = Number(n);\n  return Number.isFinite(v) ? v : def;\n}\nfunction makeKey(item) {\n  var _item$id;\n  // รวมซ้ำโดยอิง product id + variant id (ถ้ามี)\n  const id = String((_item$id = item.id) !== null && _item$id !== void 0 ? _item$id : '');\n  const vid = item.variantId != null ? String(item.variantId) : '';\n  return `${id}::${vid}`;\n}\nexport function getCart() {\n  try {\n    const raw = safeLocal().getItem(KEY) || '[]';\n    const arr = JSON.parse(raw);\n    return Array.isArray(arr) ? arr : [];\n  } catch {\n    return [];\n  }\n}\nexport function setCart(arr) {\n  safeLocal().setItem(KEY, JSON.stringify(arr || []));\n  dispatchChanged();\n}\nexport function addItem(item, qty = 1) {\n  var _ref, _item$variantId, _ref2, _item$name, _ref3, _item$price;\n  const cart = getCart();\n  const q = Math.max(1, normalizeNumber(qty, 1));\n\n  // ปรับฟิลด์พื้นฐานให้สะอาด\n  const base = {\n    id: item.id,\n    variantId: (_ref = (_item$variantId = item.variantId) !== null && _item$variantId !== void 0 ? _item$variantId : item.variant_id) !== null && _ref !== void 0 ? _ref : null,\n    name: (_ref2 = (_item$name = item.name) !== null && _item$name !== void 0 ? _item$name : item.product_name) !== null && _ref2 !== void 0 ? _ref2 : 'สินค้า',\n    price: normalizeNumber((_ref3 = (_item$price = item.price) !== null && _item$price !== void 0 ? _item$price : item.selling_price) !== null && _ref3 !== void 0 ? _ref3 : item.sale_price, 0),\n    img: item.img || item.image || item.thumbnail || (Array.isArray(item.images) ? item.images[0] : '')\n  };\n  const key = makeKey(base);\n  const idx = cart.findIndex(x => makeKey(x) === key);\n  if (idx > -1) {\n    cart[idx].quantity = Math.max(1, normalizeNumber(cart[idx].quantity, 1) + q);\n  } else {\n    cart.push({\n      ...base,\n      quantity: q\n    });\n  }\n  setCart(cart);\n}\nexport function updateQty(id, qty, variantId = null) {\n  const cart = getCart();\n  const q = Math.max(1, normalizeNumber(qty, 1));\n  const idx = cart.findIndex(x => makeKey({\n    id: x.id,\n    variantId: x.variantId\n  }) === makeKey({\n    id,\n    variantId\n  }));\n  if (idx > -1) {\n    cart[idx].quantity = q;\n    setCart(cart);\n  }\n}\nexport function removeItem(id, variantId = null) {\n  const cart = getCart().filter(x => makeKey(x) !== makeKey({\n    id,\n    variantId\n  }));\n  setCart(cart);\n}\nexport function clearCart() {\n  setCart([]);\n}\nexport function getCount() {\n  return getCart().reduce((s, x) => s + Math.max(1, normalizeNumber(x.quantity, 1)), 0);\n}\nexport function getTotal() {\n  return getCart().reduce((s, x) => {\n    const price = Math.max(0, normalizeNumber(x.price, 0));\n    const qty = Math.max(1, normalizeNumber(x.quantity, 1));\n    return s + price * qty;\n  }, 0);\n}\n\n// เผยแพร่ CONSTANT เผื่อ component อยากใช้ชื่ออีเวนต์\nexport const CART_EVENT = EVENT_NAME;","map":{"version":3,"names":["KEY","EVENT_NAME","safeLocal","window","localStorage","mem","v","getItem","k","_JSON$parse$k","JSON","parse","setItem","o","stringify","removeItem","dispatchChanged","dispatchEvent","Event","normalizeNumber","n","def","Number","isFinite","makeKey","item","_item$id","id","String","vid","variantId","getCart","raw","arr","Array","isArray","setCart","addItem","qty","_ref","_item$variantId","_ref2","_item$name","_ref3","_item$price","cart","q","Math","max","base","variant_id","name","product_name","price","selling_price","sale_price","img","image","thumbnail","images","key","idx","findIndex","x","quantity","push","updateQty","filter","clearCart","getCount","reduce","s","getTotal","CART_EVENT"],"sources":["D:/project19/frontend/src/lib/cart.js"],"sourcesContent":["// src/lib/cart.js\r\nconst KEY = 'cart';\r\nconst EVENT_NAME = 'cart:changed';\r\n\r\n/** ปลอดภัยเวลา localStorage ใช้ไม่ได้ (เช่น SSR / โหมด privacy) */\r\nfunction safeLocal() {\r\n  try {\r\n    if (typeof window !== 'undefined' && window.localStorage) return window.localStorage;\r\n  } catch {}\r\n  // fallback in-memory (จะหายเมื่อรีเฟรช)\r\n  const mem = { v: '{}' };\r\n  return {\r\n    getItem: k => (JSON.parse(mem.v || '{}'))[k] ?? null,\r\n    setItem: (k, v) => { const o = JSON.parse(mem.v || '{}'); o[k] = v; mem.v = JSON.stringify(o); },\r\n    removeItem: k => { const o = JSON.parse(mem.v || '{}'); delete o[k]; mem.v = JSON.stringify(o); }\r\n  };\r\n}\r\n\r\nfunction dispatchChanged() {\r\n  if (typeof window !== 'undefined') {\r\n    window.dispatchEvent(new Event(EVENT_NAME));\r\n  }\r\n}\r\n\r\nfunction normalizeNumber(n, def = 0) {\r\n  const v = Number(n);\r\n  return Number.isFinite(v) ? v : def;\r\n}\r\n\r\nfunction makeKey(item) {\r\n  // รวมซ้ำโดยอิง product id + variant id (ถ้ามี)\r\n  const id = String(item.id ?? '');\r\n  const vid = item.variantId != null ? String(item.variantId) : '';\r\n  return `${id}::${vid}`;\r\n}\r\n\r\nexport function getCart() {\r\n  try {\r\n    const raw = safeLocal().getItem(KEY) || '[]';\r\n    const arr = JSON.parse(raw);\r\n    return Array.isArray(arr) ? arr : [];\r\n  } catch {\r\n    return [];\r\n  }\r\n}\r\n\r\nexport function setCart(arr) {\r\n  safeLocal().setItem(KEY, JSON.stringify(arr || []));\r\n  dispatchChanged();\r\n}\r\n\r\nexport function addItem(item, qty = 1) {\r\n  const cart = getCart();\r\n  const q = Math.max(1, normalizeNumber(qty, 1));\r\n\r\n  // ปรับฟิลด์พื้นฐานให้สะอาด\r\n  const base = {\r\n    id: item.id,\r\n    variantId: item.variantId ?? item.variant_id ?? null,\r\n    name: item.name ?? item.product_name ?? 'สินค้า',\r\n    price: normalizeNumber(item.price ?? item.selling_price ?? item.sale_price, 0),\r\n    img: item.img || item.image || item.thumbnail || (Array.isArray(item.images) ? item.images[0] : ''),\r\n  };\r\n\r\n  const key = makeKey(base);\r\n  const idx = cart.findIndex(x => makeKey(x) === key);\r\n\r\n  if (idx > -1) {\r\n    cart[idx].quantity = Math.max(1, normalizeNumber(cart[idx].quantity, 1) + q);\r\n  } else {\r\n    cart.push({ ...base, quantity: q });\r\n  }\r\n  setCart(cart);\r\n}\r\n\r\nexport function updateQty(id, qty, variantId = null) {\r\n  const cart = getCart();\r\n  const q = Math.max(1, normalizeNumber(qty, 1));\r\n  const idx = cart.findIndex(x => makeKey({ id: x.id, variantId: x.variantId }) === makeKey({ id, variantId }));\r\n  if (idx > -1) {\r\n    cart[idx].quantity = q;\r\n    setCart(cart);\r\n  }\r\n}\r\n\r\nexport function removeItem(id, variantId = null) {\r\n  const cart = getCart().filter(x => makeKey(x) !== makeKey({ id, variantId }));\r\n  setCart(cart);\r\n}\r\n\r\nexport function clearCart() {\r\n  setCart([]);\r\n}\r\n\r\nexport function getCount() {\r\n  return getCart().reduce((s, x) => s + Math.max(1, normalizeNumber(x.quantity, 1)), 0);\r\n}\r\n\r\nexport function getTotal() {\r\n  return getCart().reduce((s, x) => {\r\n    const price = Math.max(0, normalizeNumber(x.price, 0));\r\n    const qty = Math.max(1, normalizeNumber(x.quantity, 1));\r\n    return s + price * qty;\r\n  }, 0);\r\n}\r\n\r\n// เผยแพร่ CONSTANT เผื่อ component อยากใช้ชื่ออีเวนต์\r\nexport const CART_EVENT = EVENT_NAME;\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}